name: Deploy Backend

on:
    push:
        branches: [main]
        paths:
            - "backend/**"
            - ".github/workflows/deploy-backend.yml"
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy to Cloud Run
        runs-on: ubuntu-latest

        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for Artifact Registry
              run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

            - name: Build and Push Container
              run: |
                  docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/kultur/api:${{ github.sha }} ./backend
                  docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/kultur/api:${{ github.sha }}

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy kultur-api \
                    --image us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/kultur/api:${{ github.sha }} \
                    --region us-central1 \
                    --platform managed \
                    --allow-unauthenticated \
                    --min-instances 0 \
                    --max-instances 2 \
                    --memory 256Mi \
                    --cpu 1 \
                    --port 8080 \
                    --set-secrets="DATABASE_URL=DATABASE_URL:latest,RESEND_API_KEY=RESEND_API_KEY:latest,ADMIN_API_KEY=ADMIN_API_KEY:latest"
